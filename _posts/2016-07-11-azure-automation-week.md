---
id: 536
title: Azure Automation Week!
date: 2016-07-11T15:59:12+00:00
author: ryan2065@gmail.com
layout: post
guid: http://www.ephingadmin.com/?p=536
permalink: /azure-automation-week/
categories:
  - Azure Automation
  - ConfigMgr
---
<p><font size="2">This week is Azure Automation week here at EphingAdmin! This week you will find new posts every day on cool things you can do with Azure Automation, SCSM, and SCCM. On Friday, you’ll see everything come together in a dynamic offline SCCM OSD task sequence!</font></p> <p><font size="2">Today, we will go over the setup. We will need an Azure AD Subscription, Azure AD Service Account, OMS Account, and an Azure Automation account. Don’t worry, all of this is free and easy to set up. I’ll break this up into sections, so if you already have a part complete, you can skip over it. You can find these sections by doing Ctrl+F and searching for the string! The poor mans table of contents!</font></p> <p><font size="2">The sections are going to be:</font></p> <p><font size="2">1) Sign up for Azure<br>2) Create a service account in Azure<br>3) Sign up for OMS<br>4) Download &amp; install the OMS agent<br>5) Create the Azure Automation account<br>6) Give your service account permissions to the Azure Automation account<br>7) Set up the Hybrid Runbook Worker</font></p> <p><font size="2">If you want additional information on this process, </font><a href="http://www.scconfigmgr.com/2015/11/06/how-to-use-azure-automation-with-configmgr/" target="_blank"><font size="2">Nickolaj Andersen has a great blog post on Azure Automation and SCCM.</font></a></p> <p align="center"><strong><font size="2">Sign up for Azure</font></strong></p> <p align="left"><font size="2">Go to <a href="https://manage.windowsazure.com" target="_blank">manage.windowsazure.com</a> and sign up for a new account. They give you $200 for signing up, so you can play around with things that cost money if you want. In this example, we will not be signing up for anything that costs money!</font></p> <p align="center"><font size="2"><strong>Create a service account in Azure</strong></font></p> <p align="left"><font size="2">Since we are at <a href="https://manage.windowsazure.com" target="_blank">manage.windowsazure.com</a> already, might as well create the service account we need! Scroll down to Active Directory and click Default Directory:</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb.png" width="321" height="484"></a></p> <p align="left"><font size="2">Click Users –&gt; Add User (at the bottom of page)</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-1.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-1.png" width="244" height="147"></a></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-2.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-2.png" width="244" height="80"></a></p> <p align="left"><font size="2">The user profile just needs to be a user</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-3.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-3.png" width="644" height="450"></font></a></p> <p><font size="2">Go through the prompts and make sure to write down the username (full username, with the @ piece) and temporary password. Once you have the user, go to portal.azure.com, sign out of your account and sign in with this new user. It will prompt you to change the password. Do that. Now you can sign back out of the account and sign in with your real one. You now have a AD user create with a real password!</font></p> <p align="center"><strong><font size="2">Sign up for OMS</font></strong></p> <p align="left"><font size="2">Go to </font><a href="https://www.microsoft.com/en-us/cloud-platform/operations-management-suite" target="_blank"><font size="2">https://www.microsoft.com/en-us/cloud-platform/operations-management-suite</font></a><font size="2"> and click Sign In. You should get this screen after you log in:</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-4.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-4.png" width="644" height="202"></a></p> <p><font size="2">Click Ok and then fill in the information on the OMS page:</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-5.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-5.png" width="644" height="154"></font></a></p> <p><font size="2">Fill it all out then click create!</font></p> <p><font size="2">Now you can select the subscription you want to associate the account with. </font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-6.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-6.png" width="644" height="267"></font></a></p> <p><font size="2">I always link it to my free trial. I don’t know if it will let you proceed with “Not Now” or not. I do know that OMS never charges my subscription, so it might work. You are always set up with a free account first!</font></p> <p><font size="2">Now you have an OMS account:</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-7.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-7.png" width="644" height="437"></font></a></p> <p align="center"><font size="2"><strong>Download &amp; install the OMS agent</strong></font></p> <p align="left"><font size="2">You need the OMS agent to get a Hybrid Runbook Worker. This is needed to run scripts on prem in your environment. Otherwise, all the scripts we create in Azure Automation will be run in the cloud, and who wants that?!</font></p> <p align="left"><font size="2">You can’t download the agent until you add at least one subscription. Since we are doing Azure Automation, you might as well add that. Add as many as you want! OMS will gather information and keep 500mb for 7 days for free. This gives you some ability to play around with it. If you’re just adding Azure Automation, make sure it’s checked and click Add Selected Solution:</font></p> <p align="left"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-8.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-8.png" width="644" height="396"></font></a></p> <p><font size="2">Now, click Connected Sources and download the Windows Agent (64 bit)</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-9.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-9.png" width="644" height="472"></font></a></p> <ol> <li> <div align="left"><font size="2">Once it's downloaded, install the agent on a computer in your environment, but keep this page open! The installer asks for your workspace ID and key. Whatever computer you choose will be the one we run scripts on for Azure Automation, so keep that in mind when you choose. I have a direct access server in my lab, and chose that one since it doesn’t do much. I won’t link all the screens in the installer, just the ones you need to change the defaults:</font></div></li> <li> <div align="left"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-10.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-10.png" width="620" height="484"></font></a></div></li> <li> <div align="left"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-11.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-11.png" width="644" height="477"></font></a></div></li> <li> <div align="left"><font size="2">Select connect the agent to Azure Log Analytics (above). Then put in the Workspace ID and one of the keys (either Primary or Secondary) from the webpage. </font></div></li> <li> <div align="left"><font size="2">.</font></div></li> <li> <div align="left"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-12.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-12.png" width="631" height="484"></font></a></div></li></ol> <p><font size="2"></font></p> <p><font size="2"></font></p> <p><font size="2">Then install! You’ll now have a computer connected to OMS!</font></p> <p align="center"><strong><font size="2">Create the Azure Automation account</font></strong></p> <p align="left"><font size="2">You’ll now need to create an azure automation account. You are meant to have multiple Azure Automation accounts in your environment. You can only set permissions on the account itself, not on individual runbooks, so I like to split them up by function. Since this account is going to be for OSD, and there will be a service account with run permission to ALL runbooks in this account, I’d suggest an OSD account that is only for your OSD scripts.</font></p> <p align="left"><font size="2">Go to </font><a href="https://portal.azure.com" target="_blank"><font size="2">portal.azure.com</font></a><font size="2"> and click Browse:</font></p> <p align="left"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-13.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-13.png" width="644" height="455"></font></a></p> <p><font size="2">Select Automation Accounts from the list:</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-14.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-14.png" width="266" height="484"></font></a></p> <p><font size="2"></font></p> <p><font size="2">Now click Add</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-15.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-15.png" width="644" height="288"></font></a></p> <p><font size="2">Fill out the information, check “Pin to Dashboard” for easy access, then click create!</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-16.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-16.png" width="278" height="484"></font></a></p> <p><font size="2">If you selected Pin to Dashboard, you should now see this on your dashboard:</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-17.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-17.png" width="174" height="174"></font></a></p> <p><font size="2">You now have an Azure Automation account!</font></p> <p align="center"><strong><font size="2">Give your service account permissions to the Azure Automation account</font></strong></p> <p align="left"><font size="2">Open up your Azure Automation account, then click the Access icon at the top (the people icon between the cloud icon and tag icon)</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-18.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-18.png" width="644" height="214"></font></a></p> <p><font size="2">Now click Add</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-19.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-19.png" width="644" height="333"></font></a></p> <p><font size="2">We need to give this account two permissions. Automation Operator and Reader. You can only give permissions one at a time, so first we will give Automation Operator.</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-20.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-20.png" width="644" height="472"></font></a></p> <p><font size="2">Add your OSD Service Account</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-21.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-21.png" width="644" height="419"></font></a></p> <p><font size="2">Click Ok at the bottom</font></p> <p align="center"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-22.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-22.png" width="177" height="484"></font></a></p> <p><font size="2">Now go through the same process and give the OSD service account permissions for Reader.</font></p> <p align="center"><font size="2"><strong>Set up the Hybrid Runbook Worker</strong></font></p> <p align="left"><font size="2">Make sure you are on portal.azure.com and select your automation account. Then click the keys icon at the top (next to the cloud)</font></p> <p align="left"><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-23.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-23.png" width="644" height="179"></font></a></p> <p><font size="2">Keep this information up as we need to register the OMS agent to this account. Now, go to the computer you installed the OMS agent on earlier in this post and fire up an admin PowerShell session. Import the Azure Automation hybrid registration cmdlet at CC:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\7.2.10681.0\HybridRegistration\HybridRegistration.psd1 –&gt; NOTE: the number 7.2… is the version number. It may be different when you install. </font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-24.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-24.png" width="644" height="90"></font></a></p> <p><font size="2">Now, run the Add-HybridRunbookWorker cmdlet. You’ll need to specify the URL, Key, and GroupName parameters. Since URL and Key should be hidden from the public, I won’t show you a screenshot of me running it. Make sure you copy URL and Key from the portal (what we did at the start of this section). GroupName can be whatever you want, but you can’t use spaces. This will be the hybrid runbook worker group. If you wanted multiple hybrid runbook workers in this group, run this cmdlet on multiple computers specifying the same groupname. </font></p> <p><font size="2">Once this is run, you’ll have a hybrid worker group!</font></p> <p><a href="http://www.ephingadmin.com/wp-content/uploads/2016/07/image-25.png"><font size="2"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="http://www.ephingadmin.com/wp-content/uploads/2016/07/image_thumb-25.png" width="187" height="87"></font></a></p> <p><font size="2">And that’s it! We now have an account all set up and ready to go!</font></p> <p><font size="2">Here’s the schedule for the rest of the week:</font></p> <p><font size="2">Tuesday: Run a runbook in PowerShell without the cmdlets!<br>Wednesday: Get imaging information with the SCSM portal ahead of time, and gather that information with an Azure Automation Runbook<br>Thursday: Join a computer to the domain through Azure Automation with offline domain join<br>Friday: Put it all together in SCCM OSD to create dynamic offline media that can join computers to the domain from anywhere! Your security guys will love it!</font></p>